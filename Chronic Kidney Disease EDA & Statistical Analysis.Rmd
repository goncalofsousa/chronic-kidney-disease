---
title: "Chronic Kidney Disease EDA & Statistical Analysis"
author: "Gonçalo Sousa"
date: "2025-08-22"
output:
  pdf_document: default
  html_document: default
---

# Introduction

This project showcases my skills in data analysis and statistical reasoning through an exploratory study of a clinical dataset on Chronic Kidney Disease (CKD) from [UCI Machine Learning Repository](https://archive.ics.uci.edu/dataset/336/chronic+kidney+disease). 

The purpose of this project is to explore patterns in the dataset, investigate relationships between variables, and demonstrate practical statistical analysis skills.

The analysis includes:

1. **Data Cleaning and Pre-processing** – managing missing data, converting variable types, and preparing the dataset for analysis.

2. **Exploratory Data Analysis (EDA)** – summarizing distributions, visualizing patterns, and uncovering trends in the data.

3. **Statistical Inference** – applying correlation analyses, regression models, and hypothesis testing to extract meaningful insights.


# Data Overview

In this section, I provide a brief overview of the Chronic Kidney Disease (CKD) dataset, including the types of variables, summary statistics, and a preview of the first rows. This helps to understand the structure of the data before proceeding to cleaning and analysis.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
# Load necessary libraries
library(tidyverse)
library(knitr)
library(ggplot2)
library(fastDummies)
library(dplyr)
library(broom)
library(logistf)
library(patchwork)

# Load the dataset
ckd <- read.csv("Dataset from the data/")

# Display structure of the dataset: number of rows, columns, and variable types
glimpse(ckd)

# Summary statistics for all variables
summary(ckd)

# Preview first 10 rows to check data format
head(ckd, 10)

```

# Data Cleaning

Before analysis, it is essential to clean and preprocess the dataset.

1. **Handle missing values –** entries may be missing or represented by "?".
2. **Convert categorical variables to factors –** ensures proper handling in analyses.
3. **Convert numeric variables –** enables accurate calculations.
4. **Remove rows with missing values –** simplifies analysis and prevents errors.

```{r}

# Replace placeholder "?" with NA
ckd[ckd == "?"] <- NA

# Convert categorical variables to factors, specifying the correct levels

ckd$Red.Blood.Cells <- factor(ckd$Red.Blood.Cells, 
                                levels = c("normal", "abnormal"))
ckd$Pus.Cell <- factor(ckd$Pus.Cell, 
                         levels = c("normal", "abnormal"))
ckd$Pus.Cell.clumps <- factor(ckd$Pus.Cell.clumps, 
                                levels = c("notpresent", "present"))
ckd$Bacteria <- factor(ckd$Bacteria, 
                       levels = c("notpresent", "present"))
ckd$Hypertension <- factor(ckd$Hypertension, 
                           levels = c("no", "yes"))
ckd$Diabetes.Mellitus <- factor(ckd$Diabetes.Mellitus, 
                                  levels = c("no", "yes"))
ckd$Coronary.Artery.Disease <- factor(ckd$Coronary.Artery.Disease, 
                                        levels = c("no", "yes"))
ckd$Appetite <- factor(ckd$Appetite, 
                       levels = c("good", "poor"))
ckd$Pedal.Edema <- factor(ckd$Pedal.Edema, 
                            levels = c("no", "yes"))
ckd$Anemia <- factor(ckd$Anemia, 
                     levels = c("no", "yes"))
ckd$Class <- factor(ckd$Class,
                    levels = c("notckd", "ckd"))

# Convert numeric columns

ckd$Age <- as.numeric(ckd$Age)
ckd$Blood.Pressure <- as.numeric(ckd$Blood.Pressure)
ckd$Specific.Gravity <- as.numeric(ckd$Specific.Gravity)
ckd$Albumin <- as.numeric(ckd$Albumin)
ckd$Sugar <- as.numeric(ckd$Sugar)
ckd$Blood.Glucose.Random <- as.numeric(ckd$Blood.Glucose.Random)
ckd$Blood.Urea <- as.numeric(ckd$Blood.Urea)
ckd$Serum.Creatinine <- as.numeric(ckd$Serum.Creatinine)
ckd$Sodium <- as.numeric(ckd$Sodium)
ckd$Potassium <- as.numeric(ckd$Potassium)
ckd$Hemoglobin <- as.numeric(ckd$Hemoglobin)
ckd$Packed.Cell.Volume <- as.numeric(ckd$Packed.Cell.Volume)
ckd$White.Blood.Cell.Count <- as.numeric(ckd$White.Blood.Cell.Count)
ckd$Red.Blood.Cell.Count <- as.numeric(ckd$Red.Blood.Cell.Count)

# Remove rows with any missing values
ckd_clean <- na.omit(ckd)

# Rename col names
names(ckd_clean) <- tolower(gsub("\\.", "_", names(ckd_clean)))

# Display how many rows remain after cleaning
cat("Number of rows after cleaning:", nrow(ckd_clean))
```

# Exploratory Data Analysis (EDA)

EDA allows us to understand distributions, patterns, and relationships in the dataset.

## 1. Numeric Variables

**Objective:** Explore distributions, detect outliers, and identify potential patterns.

```{r}
# List of numeric variables
numeric_cols <- c("age", "blood_pressure", "specific_gravity", "albumin", 
                  "sugar", "blood_glucose_random", "blood_urea", "serum_creatinine",
                  "sodium", "potassium", "hemoglobin", "packed_cell_volume",
                  "white_blood_cell_count", "red_blood_cell_count")

# Histograms
for(col in numeric_cols){
  print(
    ggplot(ckd_clean, aes_string(x = col)) +
      geom_histogram(binwidth = 5, fill="steelblue", color="black") +
      labs(title = paste("Distribution of", col), x = col, y = "Count") +
      theme_minimal()
  )
}

```

```{r}
# Boxplots for outliers
for(col in numeric_cols){
  print(
    ggplot(ckd_clean, aes_string(y = col)) +
      geom_boxplot(fill="tomato") +
      labs(title = paste("Boxplot of", col), y = col) +
      theme_minimal()
  )
}

```
**Insights:** This step helps to identify skewed distributions, presence of outliers, and overall patterns in numeric variables.

## 2. Categorical Variables

**Objective:** Explore frequencies, proportions, and potential imbalances.

```{r}
categorical_cols <- c("red_blood_cells", "pus_cell", "pus_cell_clumps", 
                      "bacteria", "hypertension", "diabetes_mellitus", 
                      "coronary_artery_disease", "appetite", "pedal_edema", 
                      "anemia", "class")

for(col in categorical_cols){
  print(
    ggplot(ckd_clean, aes_string(x=col, fill=col)) +
      geom_bar() +
      geom_text(stat='count', aes(label=..count..), vjust=-0.5) +
      labs(title=paste("Distribution of", col), x=col, y="Count") +
      theme_minimal()
  )
}

```

**Insights:** Check if some categories are imbalanced (e.g., CKD vs non-CKD), which might influence subsequent analyses.

## 3. Relationships between Numeric Variables and CKD Class

**Objective:** Compare distributions of numeric variables across CKD vs non-CKD patients.

```{r}
for(col in numeric_cols){
  print(
    ggplot(ckd_clean, aes_string(x="class", y=col, fill="class")) +
      geom_boxplot() +
      labs(title=paste(col, "by CKD Class"), x="class", y=col) +
      theme_minimal()
  )
}

```
**Insights:** Highlights which numeric variables show differences between CKD and non-CKD patients, guiding potential predictors for further statistical inference.

## 4. Relationships between Categorical Variables and CKD Class

```{r}
for(col in categorical_cols[categorical_cols != "class"]){
  print(
    ggplot(ckd_clean, aes_string(x=col, fill="class")) +
      geom_bar(position="dodge") +
      labs(title=paste(col, "vs CKD Class"), x=col, y="Count") +
      theme_minimal()
  )
}

```

**Insights:** Helps to visually identify factors potentially associated with CKD, such as hypertension, diabetes, or anemia.

## 5. Descriptive Statistics by CKD Class

```{r}
ckd_clean %>%
  group_by(class) %>%
  summarise(
    across(all_of(numeric_cols), 
           list(mean = ~mean(.x, na.rm=TRUE),
                sd = ~sd(.x, na.rm=TRUE),
                median = ~median(.x, na.rm=TRUE),
                min = ~min(.x, na.rm=TRUE),
                max = ~max(.x, na.rm=TRUE)),
           .names = "{col}_{fn}")
  ) %>%
  kable(caption = "Descriptive statistics of numeric variables by CKD class")
```

**Insights:** Provides clear summaries of numeric differences between CKD and non-CKD patients, useful for identifying potential predictors.

# Statistical Inference

Statistical inference allows us to go beyond simple observation of the data and formally test hypotheses, identify relationships, and quantify associations between variables. In this section, we aim to:

1. Assess correlations between numeric variables and binarized categorical variables.

2. Identify factors potentially associated with CKD status.

3. Lay the groundwork for further modeling and hypothesis testing.

## 1. Correlations analysis

### 1.1 Preparing the data for correlation analysis

```{r}

# Separate numeric and categorical variables
numeric_vars <- ckd_clean %>%
  select(where(is.numeric))

categorical_vars <- ckd_clean %>%
  select(where(is.factor))

# Summary before encoding
cat("Numeric variables:", ncol(numeric_vars), "\n")
cat("Categorical variables:", ncol(categorical_vars), "\n")

# One-hot encoding (dummy variables) for categorical features
categorical_encoded <- categorical_vars %>%
  mutate(across(everything(), as.factor)) %>%
  fastDummies::dummy_cols(remove_first_dummy = TRUE, remove_selected_columns = TRUE)

# Combine numeric and encoded categorical variables
correlation_data <- bind_cols(numeric_vars, categorical_encoded)

# Summary after encoding
cat("Total variables after encoding:", ncol(correlation_data), "\n")
glimpse(correlation_data)

```
### 1.2 Calculating correlations

```{r}
# Calculate correlation of all variables with class
cor_with_class <- sapply(correlation_data, function(x) cor(as.numeric(x), as.numeric(ckd_clean$class), use="complete.obs"))

# Transform to data frame for visualization
cor_df <- data.frame(variable = names(cor_with_class), correlation = cor_with_class)

# Order by absolute correlation
cor_df <- cor_df %>% arrange(desc(abs(correlation)))

# Show top 10 variables most correlated with CKD
head(cor_df, 10)

```

### 1.3 Visualizing key relationships

```{r}

# Order by absolute correlation
cor_df <- cor_df %>% arrange(desc(abs(correlation)))

# Heatmap
ggplot(cor_df, aes(x = 1, y = reorder(variable, correlation), fill = correlation)) +
  geom_tile(color = "white", width = 0.8, height = 0.8) +
  scale_fill_gradient2(low = "#2c7bb6", mid = "white", high = "#d7191c", midpoint = 0,
                       limits = c(-1, 1), name = "Correlation") +
  geom_text(aes(label = sprintf("%.2f", correlation)), color = "black", size = 3.5) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    panel.grid = element_blank(),
    plot.title = element_text(face = "bold", hjust = 0.5)
  ) +
  labs(
    x = "",
    y = "Variable",
    title = "Correlation of Variables with CKD Class"
  )
```

### 1.4 Interpretation of Correlations with CKD Class

The correlation of each variable with the CKD class (0 = not CKD, 1 = CKD). Positive correlations indicate that higher values or presence of the factor are associated with CKD, while negative correlations indicate that lower values are associated with CKD.

The strongest positive correlations are observed for `albumin` (0.92), `hypertension_yes` (0.87), and `pus_cell_abnormal` (0.78), suggesting that higher albumin levels, presence of hypertension, and abnormal pus cells are strongly linked with CKD. Conversely, `hemoglobin` (-0.84), `packed_cell_volume` (-0.83), `specific_gravity` (-0.79), and `red_blood_cell_count` (-0.78) show strong negative correlations, indicating that lower values of these variables are characteristic of CKD patients.

Moderate correlations are seen for `serum_creatinine` (0.69), `blood_urea` (0.67), `sodium` (-0.64), and `appetite_poor` (0.62), while `age`, `blood_pressure`, and `potassium` show weaker associations with CKD in this dataset.

Overall, this analysis highlights the most relevant features for distinguishing CKD patients and provides guidance for further statistical inference and predictive modeling.

## 2. Prioritization of variables to test formally

### 2.1  Formal Testing of Numeric Variables

I will formally test whether the numeric variables most correlated with CKD differ significantly between CKD and non-CKD patients. For normally distributed variables, I use a t-test; for non-normal distributions, I use the Wilcoxon rank-sum test.

```{r}
# Select numeric variables to test based on correlation results
numeric_to_test <- c("albumin", "hemoglobin", "packed_cell_volume",
                     "specific_gravity", "red_blood_cell_count",
                     "serum_creatinine", "blood_urea", "sodium",
                     "blood_glucose_random")

# Function to perform Shapiro-Wilk test safely
normality_results <- lapply(numeric_to_test, function(var) {
  x_ckd <- ckd_clean[[var]][ckd_clean$class == "ckd"]
  x_notckd <- ckd_clean[[var]][ckd_clean$class == "notckd"]
  
  # Check for constant values
  if (var(x_ckd) == 0 | var(x_notckd) == 0) {
    return(data.frame(variable = var,
                      p_ckd = NA,
                      p_notckd = NA))
  } else {
    shapiro_ckd <- shapiro.test(x_ckd)
    shapiro_notckd <- shapiro.test(x_notckd)
    return(data.frame(variable = var,
                      p_ckd = shapiro_ckd$p.value,
                      p_notckd = shapiro_notckd$p.value))
  }
})

# Combine results into one data frame
normality_results <- do.call(rbind, normality_results)

# Display results
knitr::kable(normality_results, caption = "Shapiro-Wilk normality test by CKD class")



```

**Normality Test Summary**

The Shapiro-Wilk test was applied to each numeric variable separately for CKD and non-CKD patients to assess normality. Variables with constant values in any group (e.g., `albumin`) were not tested, resulting in NA p-values.

Key observations:

1. Several variables significantly deviate from normality in at least one group, including `specific_gravity`, `serum_creatinine`, `blood_urea`, `blood_glucose_random`, `sodium`.

2. Some variables appear approximately normal in one group but not in the other, such as `hemoglobin`.

3. Variables like `red_blood_cell_count` and `packed_cell_volume` show mixed results, being normal in CKD patients but non-normal in non-CKD patients.

**Conclusion:**

Given the presence of non-normal distributions in multiple variables, non-parametric tests (e.g., Wilcoxon rank-sum) are recommended for comparing CKD and non-CKD groups, while t-tests could still be applied cautiously for variables that pass normality in both groups.

**Statistical Test**

Since normality is not satisfied for many variables, we applied the Wilcoxon rank-sum test (also known as Mann-Whitney U test) to compare numeric variables between CKD and non-CKD patients. This non-parametric test does not assume normality and is appropriate for skewed distributions.

```{r}
# Select numeric variables to test based on correlation results
numeric_to_test <- c("albumin", "hemoglobin", "packed_cell_volume",
                     "specific_gravity", "red_blood_cell_count",
                     "serum_creatinine", "blood_urea", "sodium",
                     "blood_glucose_random")

# Perform Wilcoxon rank-sum test
wilcox_results <- lapply(numeric_to_test, function(var) {
  test <- wilcox.test(ckd_clean[[var]] ~ ckd_clean$class)
  data.frame(variable = var,
             statistic = test$statistic,
             p_value = test$p.value)
})

# Combine results into a data frame
wilcox_results_df <- do.call(rbind, wilcox_results)

# Adjust p-values for multiple testing using Bonferroni correction
wilcox_results_df$p_adj <- p.adjust(wilcox_results_df$p_value, method = "bonferroni")

# Order by adjusted p-value
wilcox_results_df <- wilcox_results_df %>% arrange(p_adj)

# Display results
wilcox_results_df


```

**Wilcoxon Rank-Sum Test Results:**

The Wilcoxon rank-sum test identifies significant differences in numeric variables between CKD and non-CKD patients. After Bonferroni correction, the most significant differences are observed for:

* Albumin (`p_adj ≈ 1.97e-32`) – CKD patients show higher albumin levels compared to non-CKD.
* Hemoglobin (`p_adj ≈ 5.51e-19`) – lower in CKD patients.
* Packed Cell Volume (`p_adj ≈ 9.71e-19`) – lower in CKD patients.
* Red Blood Cell Count (`p_adj ≈ 1.24e-18`) – lower in CKD patients.
* Specific Gravity (`p_adj ≈ 1.33e-16`) – lower in CKD patients.
* Serum Creatinine (`p_adj ≈ 6.88e-19`) – higher in CKD patients.
* Blood Urea (`p_adj ≈ 4.53e-14`) – higher in CKD patients.
* Sodium (`p_adj ≈ 4.94e-13`) – lower in CKD patients.
* Blood Glucose Random (`p_adj ≈ 2.98e-07`) – higher in CKD patients.

These results complement the correlation analysis, confirming that albumin, hemoglobin, packed cell volume, red blood cell count, and specific gravity are among the strongest discriminators of CKD in this dataset.

```{r}
# List of numeric variables to test
numeric_to_test <- c("albumin", "hemoglobin", "packed_cell_volume",
                     "specific_gravity", "red_blood_cell_count",
                     "serum_creatinine", "blood_urea", "sodium",
                     "blood_glucose_random")

# Wilcoxon test + Effect size (Base R implementation)
wilcox_results <- lapply(numeric_to_test, function(var) {
  # Build formula (numeric variable ~ class)
  formula <- as.formula(paste(var, "~ class"))
  
  # Perform Wilcoxon test
  test <- wilcox.test(formula, data = ckd_clean, exact = FALSE)
  
  # Calculate effect size manually (r = Z / sqrt(N))
  n <- nrow(ckd_clean)
  z <- qnorm(test$p.value / 2, lower.tail = FALSE) * 
       sign(test$statistic - (n^2 / 4))
  r <- z / sqrt(n)
  
  # Return results as data frame
  data.frame(
    variable   = var,
    statistic  = test$statistic,
    p_value    = test$p.value,
    p_adj      = p.adjust(test$p.value, method = "bonferroni"),
    effect_size = r
  )
})

# Combine results into a single data frame and sort by adjusted p-value
wilcox_results_df <- do.call(rbind, wilcox_results) %>%
  arrange(p_adj)

# Display results
print(wilcox_results_df)
```

**Interpretation of Effect Sizes (r) – Wilcoxon Rank-Sum Test:**

* Albumin (r ≈ -0.97): Very large difference; CKD patients have substantially higher albumin levels compared to non-CKD.
* Hemoglobin (r ≈ -0.73): Large difference; lower in CKD patients.
* Serum Creatinine (r ≈ -0.73): Large difference; higher in CKD patients.
* Packed Cell Volume (r ≈ -0.73): Large difference; lower in CKD patients.
* Red Blood Cell Count (r ≈ -0.73): Large difference; lower in CKD patients.
* Specific Gravity (r ≈ -0.69): Large difference; lower in CKD patients.
* Blood Urea (r ≈ -0.63): Moderate to large difference; higher in CKD patients.
* Sodium (r ≈ -0.60): Moderate to large difference; lower in CKD patients.
* Blood Glucose Random (r ≈ -0.44): Moderate difference; higher in CKD patients.

All numeric variables tested show clinically meaningful differences between CKD and non-CKD patients. The strongest differences are observed for albumin, hemoglobin, serum creatinine, packed cell volume, and red blood cell count, confirming the patterns previously observed in correlation analysis.


```{r}
# Plot
plot_list <- lapply(numeric_to_test, function(var) {
  ggplot(ckd_clean, aes(x = class, y = .data[[var]], fill = class)) +
    geom_violin(trim = FALSE, alpha = 0.3) +
    geom_boxplot(width = 0.2, outlier.shape = NA, alpha = 0.6) +
    geom_jitter(width = 0.1, alpha = 0.5, size = 1) +
    labs(title = var, x = "", y = var) +
    theme_minimal() +
    theme(legend.position = "none")
})

# Display
wrap_plots(plot_list)
```

### 2.2 Formal Testing of Categoric Variables

I will formally test whether the selected categorical variables (hypertension, pus_cell, diabetes_mellitus, and appetite) are associated with CKD status. For each variable, I perform a Chi-squared test of independence. If the expected counts are too low (less than 5 in any cell), I use Fisher's exact test instead. For 2x2 tables, I also calculate the odds ratio to quantify the strength of the association. Visual summaries are provided to illustrate differences in proportions between CKD and non-CKD patients.

```{r}

# Selected categorical variables
cat_vars <- c("hypertension", "pus_cell", "diabetes_mellitus", "appetite")

# Loop to create bar plots
for(var in cat_vars){
  
  # Contingency table
  tab <- table(ckd_clean[[var]], ckd_clean$class)
  
  # Decide test
  test <- if(any(chisq.test(tab)$expected < 5)){
    fisher.test(tab)
  } else {
    chisq.test(tab)
  }
  
  # Odds ratio for 2x2
  or <- if(all(dim(tab) == c(2,2))){
    (tab[2,2] * tab[1,1]) / (tab[1,2] * tab[2,1])
  } else { NA }
  
  # Print test summary
  cat("\nVariable:", var, "\n")
  print(tab)
  cat("Test:", ifelse(any(chisq.test(tab)$expected < 5), "Fisher", "Chi-squared"), "\n")
  cat("p-value:", round(test$p.value, 5), "\n")
  if(!is.na(or)) cat("Odds ratio:", round(or, 3), "\n")
  
# Create proportion bar plot
  prop_data <- prop.table(tab, margin = 2) %>% as.data.frame()
  names(prop_data) <- c(var, "class", "proportion")
  
  ggplot(prop_data, aes_string(x="class", y="proportion", fill=var)) +
    geom_bar(stat="identity", position="dodge") +
    geom_text(aes(label=round(proportion,2)), 
              position=position_dodge(width=0.9), vjust=-0.5) +
    labs(title=paste("Proportion of", var, "by CKD Class"),
         x="CKD Class", y="Proportion") +
    theme_minimal() -> p
  
  print(p)
}

```

**Interpretation of Categorical Variable Tests**

All four categorical variables show perfect separation between CKD and non-CKD patients in this dataset. The Chi-squared tests yield **p-values < 0.001** (reported as 0 due to rounding), indicating a statistically significant association with CKD.

The **odds ratios are infinite**, reflecting that for non-CKD patients, all counts fall into a single category. This suggests these variables are strongly predictive of CKD status:
* **Hypertension:** All CKD patients have hypertension, while non-CKD patients have none.
* **Pus Cell:** Abnormal pus cells are present only in CKD patients.
* **Diabetes Mellitus:** Diabetes is present exclusively among CKD patients in this sample.
* **Appetite:** Poor appetite occurs only in CKD patients.

These categorical variables exhibit a complete separation between CKD and non-CKD groups, highlighting their strong association and potential predictive value.

## 3. Regression Analysis

```{r}
# Define variables of interest
numeric_vars <- c("albumin", "hemoglobin", "packed_cell_volume",
                  "specific_gravity", "red_blood_cell_count",
                  "serum_creatinine", "blood_urea", "sodium",
                  "blood_glucose_random")

categorical_vars <- c("hypertension", "pus_cell", "diabetes_mellitus", "appetite")

# Ensure target is binary 0/1
ckd_clean$class_bin <- ifelse(ckd_clean$class == "ckd", 1, 0)
```

### 3.1 Univariate Logistic Regression

I performed univariate logistic regression for each variable of interest to quantify its association with CKD. The odds ratios (OR) are presented below.

```{r}
# ------------------------------
# Univariate logistic regression
# ------------------------------

univar_results <- lapply(c(numeric_vars, categorical_vars), function(var) {
  formula <- as.formula(paste("class_bin ~", var))
  model <- glm(formula, data = ckd_clean, family = binomial)
  tidy_model <- broom::tidy(model, exponentiate = TRUE, conf.int = TRUE)  # OR + 95% CI
  tidy_model$variable_name <- var
  return(tidy_model)
})

# Combine all results
univar_results_df <- do.call(rbind, univar_results)

# Optional: filter only the coefficient of the variable (exclude intercept)
univar_results_df <- univar_results_df %>% filter(term != "(Intercept)")

# Display table
univar_results_df %>% select(variable_name, term, estimate, conf.low, conf.high, p.value)

```

**Interpretation:**

* **Very strong positive** associations with CKD are seen for `albumin`, `serum_creatinine`, `hypertension_yes`, `pus_cell_abnormal`, `diabetes_mellitus_yes`, and `appetite_poor`, indicating that higher values or presence of these features greatly increase the odds of CKD.

* **Strong negative associations** are observed for `hemoglobin`, `packed_cell_volume`, `specific_gravity`, and `red_blood_cell_count`, suggesting that lower levels of these variables are characteristic of CKD patients.

* **Moderate effects** are seen for `blood_urea`, `sodium`, and `blood_glucose_random`, showing milder influence on CKD odds.

### 3.2 Multivariate Logistic Regression

A multivariate logistic regression was performed including all variables of interest to assess their independent contributions to CKD. Odds ratios (OR) are reported below.

```{r}
# ------------------------------
# Multivariate logistic regression using Firth's correction
# ------------------------------

# Combine numeric and categorical variables of interest
all_vars <- c("albumin", "hemoglobin", "packed_cell_volume", 
              "specific_gravity", "red_blood_cell_count", 
              "serum_creatinine", "blood_urea", "sodium", 
              "blood_glucose_random", "hypertension", 
              "pus_cell", "diabetes_mellitus", "appetite")

# Create formula
multivar_formula <- as.formula(paste("class_bin ~", paste(all_vars, collapse = " + ")))

# Fit penalized logistic regression (Firth)
multivar_model <- logistf(multivar_formula, data = ckd_clean,
                          control = logistf.control(maxit = 1000))

# Extract results manually
multivar_results_df <- data.frame(
  term = names(multivar_model$coefficients)[-1],           # remove intercept
  estimate = multivar_model$coefficients[-1],
  conf.low = multivar_model$ci.lower[-1],
  conf.high = multivar_model$ci.upper[-1],
  p.value = multivar_model$prob[-1]
)

# Calculate odds ratios (OR) and transform CI
multivar_results_df <- multivar_results_df %>%
  mutate(OR = exp(estimate),
         conf.low = exp(conf.low),
         conf.high = exp(conf.high))

# Display OR, 95% CI and p-values
multivar_results_df %>% select(term, OR, conf.low, conf.high, p.value)

```

**Interpretation:**

* **Strong independent positive** associations with CKD are seen for `albumin`, `pus_cell_abnormal`, and `diabetes_mellitus_yes`, suggesting that, when adjusting for all other variables, higher albumin levels, abnormal pus cells, and diabetes significantly increase the odds of CKD.

* **Strong independent negative** associations are observed for `specific_gravity`, `red_blood_cell_count`, and `appetite_poor`, indicating that lower levels or poor appetite reduce the odds of CKD in the multivariate context.

* Other variables, such as `hemoglobin`, `packed_cell_volume`, `serum_creatinine`, `blood_urea`, `sodium`, and `blood_glucose_random`, show smaller or negligible independent effects after adjustment for all factors.

# Final Remarks

This analysis confirms that CKD status is strongly associated with several numeric and categorical variables. The strongest independent predictors are albumin, pus cell abnormalities, and diabetes. These results provide a clear picture of the variables most relevant for CKD. It is important to note that this analysis was performed solely for portfolio purposes and should not be used for clinical decision-making.


